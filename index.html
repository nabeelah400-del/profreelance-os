<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PROFREELANCE OS CONTROL PANEL</title>

  <!-- Chart.js (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#05070f;
      --bg1:#070a14;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.42);
      --teal:#14b8a6;
      --teal2:#00ffd0;
      --shadow: 0 30px 80px rgba(0,0,0,.55);
      --glow: 0 0 0 1px rgba(20,184,166,.18), 0 0 40px rgba(20,184,166,.12);
      --r: 18px;
      --r2: 26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(20,184,166,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(0,255,208,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(20,184,166,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* subtle animated grid */
    .bg-grid{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.22;
      background-image:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 44px 44px;
      filter: blur(.0px);
      mask-image: radial-gradient(circle at 30% 20%, black 0%, transparent 65%);
      animation: drift 18s linear infinite;
    }
    @keyframes drift{
      0%{ transform: translate3d(0,0,0); }
      50%{ transform: translate3d(18px, 10px,0); }
      100%{ transform: translate3d(0,0,0); }
    }

    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      position:sticky; top:0;
      height:100vh;
      padding:20px 16px;
      border-right: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.08));
      backdrop-filter: blur(14px);
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      padding:14px 14px;
      border-radius: var(--r2);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--glow);
    }
    .brand .dot{
      width:12px; height:12px; border-radius:999px;
      background: var(--teal);
      box-shadow: 0 0 0 6px rgba(20,184,166,.14), 0 0 30px rgba(20,184,166,.35);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(255,255,255,.88);
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color: var(--muted);
    }

    .nav{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:6px 2px;
    }
    .nav a{
      text-decoration:none;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      transition: .18s ease;
    }
    .nav a:hover{
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.07);
    }
    .nav a.active{
      color: rgba(255,255,255,.94);
      background: rgba(20,184,166,.10);
      border-color: rgba(20,184,166,.22);
      box-shadow: 0 0 0 1px rgba(20,184,166,.10);
    }
    .nav .pill{
      font-family: var(--mono);
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.70);
      background: rgba(255,255,255,.03);
    }

    .sidebar-footer{
      position:absolute;
      left:16px; right:16px;
      bottom:16px;
      padding:12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .sidebar-footer .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .status{
      display:flex; align-items:center; gap:10px;
      font-size:12px;
      color: var(--muted);
    }
    .led{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow:none;
    }
    .led.connected{
      background: var(--teal);
      box-shadow: 0 0 0 6px rgba(20,184,166,.14), 0 0 18px rgba(20,184,166,.35);
    }
    .led.degraded{
      background: #fbbf24;
      box-shadow: 0 0 0 6px rgba(251,191,36,.14), 0 0 18px rgba(251,191,36,.30);
    }
    .led.error{
      background: #fb7185;
      box-shadow: 0 0 0 6px rgba(251,113,133,.14), 0 0 18px rgba(251,113,133,.30);
    }

    /* Main */
    .main{
      padding:24px;
      max-width: 1240px;
      width:100%;
      margin:0 auto;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .title h2{
      margin:0;
      font-size:38px;
      letter-spacing:.02em;
    }
    .title .sub{
      margin-top:8px;
      color: var(--muted);
      font-size:13px;
      font-family: var(--mono);
    }

    .top-widgets{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chip{
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.78);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(10px);
    }
    .chip b{
      color: rgba(255,255,255,.92);
      font-family: var(--mono);
      font-weight:600;
      font-size:12px;
    }
    .clock{
      font-family: var(--mono);
      font-size:12px;
      letter-spacing:.04em;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      margin-top: 10px;
    }

    .card{
      grid-column: span 12;
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 200px at 20% 0%, rgba(20,184,166,.18), transparent 65%);
      pointer-events:none;
      opacity:.8;
    }
    .card-inner{ position:relative; padding:18px; }

    .kpis{
      grid-column: span 12;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }

    .kpi{
      grid-column: span 12;
      padding:18px;
      border-radius: var(--r2);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--glow);
      position:relative;
      overflow:hidden;
    }
    .kpi::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(420px 180px at 20% 0%, rgba(20,184,166,.16), transparent 60%);
      opacity:.7;
      pointer-events:none;
    }
    .kpi .k-title{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.80);
      font-size:13px;
      margin-bottom:10px;
    }
    .badge{
      font-family: var(--mono);
      font-size:11px;
      padding:4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,184,166,.22);
      background: rgba(20,184,166,.10);
      color: rgba(255,255,255,.85);
    }
    .kpi .k-value{
      position:relative;
      font-size:44px;
      letter-spacing:.01em;
      color: var(--teal2);
      text-shadow: 0 0 28px rgba(0,255,208,.20);
      font-weight:650;
      line-height:1.05;
    }
    .kpi .k-foot{
      position:relative;
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    @media (min-width: 920px){
      .kpi{ grid-column: span 4; }
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin:0 0 10px;
    }
    .section-title h3{
      margin:0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,.82);
    }

    /* Chart area */
    .chart-wrap{
      height: 320px;
    }
    canvas{ display:block; width:100% !important; height:100% !important; }

    /* Tables */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      padding:12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    tbody td{
      padding:12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-size:13px;
    }
    tbody tr:hover td{
      background: rgba(20,184,166,.06);
    }
    tbody tr:last-child td{ border-bottom:none; }

    .muted{ color: var(--muted); }
    .right{ text-align:right; }

    .two-col{
      grid-column: span 12;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 1024px){
      .two-col{ grid-template-columns: 1.1fr .9fr; }
    }

    .mini{
      font-family: var(--mono);
      font-size:12px;
      color: var(--muted);
    }

    /* Settings note (clean) */
    .note{
      padding:14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .note h4{
      margin:0 0 8px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,255,255,.80);
    }
    .note p{
      margin:0;
      color: var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .note a{
      color: rgba(255,255,255,.90);
      text-decoration:none;
      border-bottom: 1px solid rgba(20,184,166,.35);
    }
    .note a:hover{
      border-bottom-color: rgba(0,255,208,.65);
    }

    /* small loading shimmer */
    .skeleton{
      height:18px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.10), rgba(255,255,255,.06));
      background-size: 220% 100%;
      animation: sh 1.2s linear infinite;
    }
    @keyframes sh{ 0%{ background-position: 0% 0; } 100%{ background-position: 220% 0; } }
  </style>
</head>

<body>
  <div class="bg-grid"></div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>PROFREELANCE OS</h1>
          <p class="mini">Control Panel</p>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="#overview" class="active"><span>Overview</span><span class="pill">KPIs</span></a>
        <a href="#signal"><span>Signal</span><span class="pill">Chart</span></a>
        <a href="#pipeline"><span>Pipeline</span><span class="pill">Table</span></a>
        <a href="#activity"><span>Activity</span><span class="pill">Feed</span></a>
        <a href="#revenue"><span>Revenue</span><span class="pill">Invoices</span></a>
        <a href="#settings"><span>Settings</span><span class="pill">Info</span></a>
      </nav>

      <div class="sidebar-footer">
        <div class="row">
          <div class="status">
            <span class="led" id="led"></span>
            <span id="statusText">Loading…</span>
          </div>
          <div class="mini" id="lastSync">—</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2>PROFREELANCE OS</h2>
          <div class="sub" id="subline">Live dashboard</div>
        </div>

        <div class="top-widgets">
          <div class="chip">
            <span class="muted">Refresh</span>
            <b id="refreshRate">60s</b>
          </div>
          <div class="chip">
            <span class="muted">Local time</span>
            <span class="clock" id="clock">—</span>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <section id="overview" class="kpis">
        <div class="kpi">
          <div class="k-title"><span>Revenue</span><span class="badge">ZAR</span></div>
          <div class="k-value" id="kpiRevenue"><div class="skeleton"></div></div>
          <div class="k-foot" id="kpiRevenueFoot">—</div>
        </div>

        <div class="kpi">
          <div class="k-title"><span>Active Clients</span><span class="badge">LIVE</span></div>
          <div class="k-value" id="kpiClients"><div class="skeleton"></div></div>
          <div class="k-foot" id="kpiClientsFoot">—</div>
        </div>

        <div class="kpi">
          <div class="k-title"><span>Pipeline Value</span><span class="badge">ZAR</span></div>
          <div class="k-value" id="kpiPipeline"><div class="skeleton"></div></div>
          <div class="k-foot" id="kpiPipelineFoot">—</div>
        </div>
      </section>

      <div class="grid">
        <!-- Signal -->
        <section id="signal" class="card">
          <div class="card-inner">
            <div class="section-title">
              <h3>Signal</h3>
              <div class="mini" id="signalMeta">—</div>
            </div>
            <div class="chart-wrap">
              <canvas id="signalChart"></canvas>
            </div>
          </div>
        </section>

        <div class="two-col">
          <!-- Pipeline -->
          <section id="pipeline" class="card">
            <div class="card-inner">
              <div class="section-title">
                <h3>Pipeline</h3>
                <div class="mini" id="pipelineMeta">—</div>
              </div>
              <div style="overflow:auto; border-radius:16px;">
                <table>
                  <thead>
                    <tr>
                      <th>Client</th>
                      <th class="right">Deal Value</th>
                      <th>Stage</th>
                      <th class="right">Prob.</th>
                      <th class="right">Weighted</th>
                      <th>Expected Close</th>
                    </tr>
                  </thead>
                  <tbody id="pipelineBody">
                    <tr><td colspan="6"><div class="skeleton"></div></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Activity -->
          <section id="activity" class="card">
            <div class="card-inner">
              <div class="section-title">
                <h3>Activity</h3>
                <div class="mini" id="activityMeta">—</div>
              </div>
              <div style="overflow:auto; border-radius:16px;">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Client</th>
                      <th>Event</th>
                      <th>Type</th>
                      <th>Owner</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="activityBody">
                    <tr><td colspan="6"><div class="skeleton"></div></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>

        <!-- Revenue -->
        <section id="revenue" class="card">
          <div class="card-inner">
            <div class="section-title">
              <h3>Revenue</h3>
              <div class="mini" id="revenueMeta">—</div>
            </div>
            <div style="overflow:auto; border-radius:16px;">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th class="right">Amount</th>
                    <th>Status</th>
                    <th>Invoice #</th>
                    <th>Paid Date</th>
                  </tr>
                </thead>
                <tbody id="revenueBody">
                  <tr><td colspan="6"><div class="skeleton"></div></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="settings" class="card">
          <div class="card-inner">
            <div class="section-title">
              <h3>Settings</h3>
              <div class="mini">Build: static + free tooling</div>
            </div>

            <div class="note">
              <h4>From Profreelance</h4>
              <p>
                Built to showcase automation + ops visibility.
                Visit: <a href="https://www.profreelance.co.za/" target="_blank" rel="noopener noreferrer">profreelance.co.za</a>
              </p>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ====== DATA SOURCES (your published CSV links) ======
    const CSV = {
      metrics:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=44313312&single=true&output=csv",
      signal:   "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=584175548&single=true&output=csv",
      pipeline: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=182871929&single=true&output=csv",
      activity: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=64013084&single=true&output=csv"
    };

    // ====== REFRESH SETTINGS ======
    const REFRESH_MS = 60000;          // 60s
    const MAX_FAILS_FOR_ERROR = 3;     // only show "Error" after consecutive failures
    const CACHE_BUST = true;

    // ====== DOM helpers ======
    const el = (id) => document.getElementById(id);
    const led = el("led");
    const statusText = el("statusText");
    const lastSync = el("lastSync");
    const refreshRate = el("refreshRate");

    refreshRate.textContent = Math.round(REFRESH_MS/1000) + "s";

    // ====== Formatting ======
    const fmtZar = (n) => {
      if (n === null || n === undefined || n === "" || isNaN(Number(n))) return "—";
      return "R" + Number(n).toLocaleString("en-ZA", { maximumFractionDigits: 0 });
    };
    const fmtInt = (n) => {
      if (n === null || n === undefined || n === "" || isNaN(Number(n))) return "—";
      return Number(n).toLocaleString("en-ZA", { maximumFractionDigits: 0 });
    };

    const safeText = (v) => (v ?? "").toString();

    // ====== Robust CSV parser (handles commas + quotes) ======
    function parseCSV(text){
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const c = text[i];
        const next = text[i+1];

        if (c === '"' && inQuotes && next === '"'){
          field += '"'; i++; continue;
        }
        if (c === '"'){
          inQuotes = !inQuotes;
          continue;
        }
        if (c === ',' && !inQuotes){
          row.push(field); field = "";
          continue;
        }
        if ((c === '\n' || c === '\r') && !inQuotes){
          if (c === '\r' && next === '\n') i++;
          row.push(field); field = "";
          // ignore empty trailing lines
          if (row.some(x => x !== "")){
            rows.push(row);
          }
          row = [];
          continue;
        }
        field += c;
      }
      // last field
      row.push(field);
      if (row.some(x => x !== "")) rows.push(row);

      if (!rows.length) return { headers: [], data: [] };

      const headers = rows[0].map(h => h.trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
      return { headers, data };
    }

    async function fetchCSV(url){
      const u = CACHE_BUST ? (url + (url.includes("?") ? "&" : "?") + "t=" + Date.now()) : url;
      const res = await fetch(u, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();
      return parseCSV(text);
    }

    // ====== Connection state ======
    let lastOkAt = 0;
    let consecutiveFails = 0;

    function setStatus(state, detail){
      led.className = "led " + state;
      if (state === "connected") statusText.textContent = "Connected";
      if (state === "degraded") statusText.textContent = "Degraded";
      if (state === "error") statusText.textContent = "Error";
      if (detail) statusText.textContent += " · " + detail;
    }

    function touchLastSync(){
      const d = new Date();
      lastSync.textContent = d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) ;
    }

    // ====== Chart ======
    let signalChart;

    function buildOrUpdateSignalChart(labels, revenue, pipeline, clients){
      const ctx = el("signalChart");

      const common = {
        tension: 0.35,
        pointRadius: 3,
        pointHoverRadius: 4,
        borderWidth: 2
      };

      const data = {
        labels,
        datasets: [
          {
            label: "Revenue (ZAR)",
            data: revenue,
            ...common,
            borderColor: "#14b8a6",
            pointBorderColor: "#14b8a6",
            pointBackgroundColor: "#05070f"
          },
          {
            label: "Pipeline (ZAR)",
            data: pipeline,
            ...common,
            borderColor: "#00ffd0",
            pointBorderColor: "#00ffd0",
            pointBackgroundColor: "#05070f"
          },
          {
            label: "Clients",
            data: clients,
            ...common,
            borderColor: "rgba(255,255,255,.65)",
            pointBorderColor: "rgba(255,255,255,.65)",
            pointBackgroundColor: "#05070f",
            yAxisID: "y2"
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: {
            labels: { color: "rgba(255,255,255,.72)" }
          },
          tooltip: {
            backgroundColor: "rgba(10,12,22,.92)",
            borderColor: "rgba(255,255,255,.14)",
            borderWidth: 1,
            titleColor: "rgba(255,255,255,.92)",
            bodyColor: "rgba(255,255,255,.86)"
          }
        },
        scales: {
          x: {
            ticks: { color: "rgba(255,255,255,.50)", maxRotation: 0 },
            grid: { color: "rgba(255,255,255,.05)" }
          },
          y: {
            ticks: {
              color: "rgba(255,255,255,.50)",
              callback: (v) => Number(v).toLocaleString("en-ZA")
            },
            grid: { color: "rgba(255,255,255,.05)" }
          },
          y2: {
            position: "right",
            ticks: { color: "rgba(255,255,255,.38)" },
            grid: { drawOnChartArea: false }
          }
        }
      };

      if (!signalChart){
        signalChart = new Chart(ctx, { type: "line", data, options });
      } else {
        signalChart.data = data;
        signalChart.update();
      }
    }

    // ====== Renderers ======
    function renderMetrics(metrics){
      // expecting headers: Metric, Value
      const get = (name) => {
        const row = metrics.data.find(r => (r["Metric"] || "").toLowerCase() === name.toLowerCase());
        return row ? row["Value"] : "";
      };

      const revenue = Number(get("Revenue"));
      const clients = Number(get("Active Clients"));
      const pipeline = Number(get("Pipeline Value"));

      el("kpiRevenue").textContent = fmtZar(revenue);
      el("kpiClients").textContent = fmtInt(clients);
      el("kpiPipeline").textContent = fmtZar(pipeline);

      const now = new Date().toLocaleString([], { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      el("kpiRevenueFoot").textContent = "Updated " + now;
      el("kpiClientsFoot").textContent = "Updated " + now;
      el("kpiPipelineFoot").textContent = "Updated " + now;
    }

    function renderSignal(signal){
      // Date, Revenue (ZAR), Pipeline (ZAR), Clients
      const labels = signal.data.map(r => r["Date"]).filter(Boolean);
      const revenue = signal.data.map(r => Number((r["Revenue (ZAR)"] || "").replace(/,/g,"")) || 0);
      const pipeline = signal.data.map(r => Number((r["Pipeline (ZAR)"] || "").replace(/,/g,"")) || 0);
      const clients = signal.data.map(r => Number((r["Clients"] || "").replace(/,/g,"")) || 0);

      buildOrUpdateSignalChart(labels, revenue, pipeline, clients);
      el("signalMeta").textContent = labels.length ? (labels[0] + " → " + labels[labels.length-1]) : "—";
    }

    function renderPipeline(pipeline){
      const body = el("pipelineBody");
      body.innerHTML = "";

      pipeline.data.forEach(r => {
        const tr = document.createElement("tr");

        const client = safeText(r["Client"]);
        const deal = Number((r["Deal Value"] || "").replace(/,/g,""));
        const stage = safeText(r["Stage"]);
        const prob = Number((r["Probability"] || "").replace(/,/g,""));
        const weighted = Number((r["Weighted Value"] || "").replace(/,/g,""));
        const close = safeText(r["Expected Close"]);

        tr.innerHTML = `
          <td>${client || "—"}</td>
          <td class="right">${isNaN(deal) ? "—" : fmtZar(deal)}</td>
          <td class="muted">${stage || "—"}</td>
          <td class="right">${isNaN(prob) ? "—" : prob.toFixed(2)}</td>
          <td class="right">${isNaN(weighted) ? "—" : fmtZar(weighted)}</td>
          <td class="muted">${close || "—"}</td>
        `;
        body.appendChild(tr);
      });

      el("pipelineMeta").textContent = pipeline.data.length ? (pipeline.data.length + " deal(s)") : "—";
      if (!pipeline.data.length){
        body.innerHTML = `<tr><td colspan="6" class="muted">No pipeline rows yet.</td></tr>`;
      }
    }

    function renderActivity(activity){
      const body = el("activityBody");
      body.innerHTML = "";

      activity.data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="muted">${safeText(r["Date"]) || "—"}</td>
          <td>${safeText(r["Client"]) || "—"}</td>
          <td>${safeText(r["Event"]) || "—"}</td>
          <td class="muted">${safeText(r["Type"]) || "—"}</td>
          <td class="muted">${safeText(r["Owner"]) || "—"}</td>
          <td class="muted">${safeText(r["Notes"]) || "—"}</td>
        `;
        body.appendChild(tr);
      });

      el("activityMeta").textContent = activity.data.length ? (activity.data.length + " log(s)") : "—";
      if (!activity.data.length){
        body.innerHTML = `<tr><td colspan="6" class="muted">No activity rows yet.</td></tr>`;
      }
    }

    function renderRevenue(revenue){
      // Date, Client, Amount, Status, Invoice #, Paid Date
      const body = el("revenueBody");
      body.innerHTML = "";

      revenue.data.forEach(r => {
        const tr = document.createElement("tr");
        const amt = Number((r["Amount"] || "").replace(/,/g,""));
        tr.innerHTML = `
          <td class="muted">${safeText(r["Date"]) || "—"}</td>
          <td>${safeText(r["Client"]) || "—"}</td>
          <td class="right">${isNaN(amt) ? "—" : fmtZar(amt)}</td>
          <td class="muted">${safeText(r["Status"]) || "—"}</td>
          <td class="muted">${safeText(r["Invoice #"]) || "—"}</td>
          <td class="muted">${safeText(r["Paid Date"]) || "—"}</td>
        `;
        body.appendChild(tr);
      });

      el("revenueMeta").textContent = revenue.data.length ? (revenue.data.length + " invoice(s)") : "—";
      if (!revenue.data.length){
        body.innerHTML = `<tr><td colspan="6" class="muted">No revenue rows yet.</td></tr>`;
      }
    }

    // ====== Clock ======
    function tickClock(){
      const d = new Date();
      el("clock").textContent = d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }
    setInterval(tickClock, 1000);
    tickClock();

    // ====== Navigation active state (scroll spy) ======
    const navLinks = Array.from(document.querySelectorAll("#nav a"));
    const sections = navLinks.map(a => document.querySelector(a.getAttribute("href")));
    function onScroll(){
      const y = window.scrollY + 120;
      let activeIdx = 0;
      sections.forEach((sec, i) => {
        if (sec && sec.offsetTop <= y) activeIdx = i;
      });
      navLinks.forEach((a, i) => a.classList.toggle("active", i === activeIdx));
    }
    window.addEventListener("scroll", onScroll, { passive: true });

    // ====== Main refresh ======
    async function refresh(){
      try{
        const [metrics, signal, pipeline, activity] = await Promise.all([
          fetchCSV(CSV.metrics),
          fetchCSV(CSV.signal),
          fetchCSV(CSV.pipeline),
          fetchCSV(CSV.activity),
        ]);

        // Render
        renderMetrics(metrics);
        renderSignal(signal);
        renderPipeline(pipeline);
        renderActivity(activity);

        // Revenue table comes from the "Revenue" tab, but you didn't provide a separate published CSV for it.
        // If your Revenue tab is already included in one of the published CSVs, this will be blank.
        // We'll attempt to load revenue from the "Signal" sheet? No.
        // Instead: try to load revenue by reusing activity CSV if the Revenue columns exist.
        // Best: publish Revenue tab separately later. For now we keep it empty-safe.
        renderRevenue({ data: [] });

        // Connection state
        consecutiveFails = 0;
        lastOkAt = Date.now();
        setStatus("connected");
        touchLastSync();

      } catch (e){
        consecutiveFails += 1;

        // If we had a recent success, show "Degraded" first (prevents the annoying flip)
        const secondsSinceOk = lastOkAt ? (Date.now() - lastOkAt) / 1000 : Infinity;

        if (consecutiveFails >= MAX_FAILS_FOR_ERROR && secondsSinceOk > (REFRESH_MS/1000)*2){
          setStatus("error");
        } else {
          setStatus("degraded", "retrying");
        }
      }

      // Update subline with last success age (for trust)
      if (lastOkAt){
        const ageS = Math.floor((Date.now() - lastOkAt)/1000);
        el("subline").textContent = "Live dashboard · last good sync " + ageS + "s ago";
      }
    }

    // First paint
    setStatus("degraded", "booting");
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
