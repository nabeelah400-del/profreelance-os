<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PROFREELANCE OS CONTROL PANEL</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#05070f;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.42);
      --teal:#14b8a6;

      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);

      --r-xl: 22px;
      --r-lg: 18px;
      --r-md: 14px;

      --gap: 18px;
    }

    /* NO SCROLL, EVER */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: var(--bg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
    }

    /* subtle premium background */
    .bg {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 700px at 18% 20%, rgba(20,184,166,.16), transparent 60%),
        radial-gradient(900px 520px at 78% 25%, rgba(255,255,255,.06), transparent 58%),
        radial-gradient(900px 520px at 65% 85%, rgba(20,184,166,.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%),
        linear-gradient(180deg, #05070f, #04050b);
      filter: saturate(1.05);
      pointer-events: none;
    }

    .grain {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: .09;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
    }

    .app {
      height: 100vh;
      display: grid;
      grid-template-columns: 310px 1fr;
      gap: var(--gap);
      padding: 26px;
      box-sizing: border-box;
    }

    /* Sidebar */
    .side {
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-width: 0;
      backdrop-filter: blur(14px);
    }

    .sideTop {
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .brandRow {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--teal);
      box-shadow: 0 0 0 6px rgba(20,184,166,.12), 0 0 22px rgba(20,184,166,.35);
      flex: 0 0 auto;
    }

    .brandTitle {
      font-weight: 800;
      letter-spacing: .14em;
      font-size: 12px;
      text-transform: uppercase;
      line-height: 1.1;
    }

    .brandSub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .nav {
      padding: 14px;
      display: grid;
      gap: 10px;
      align-content: start;
    }

    .navBtn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--text);
      cursor: pointer;
      user-select: none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }

    .navBtn:hover {
      transform: translateY(-1px);
      border-color: rgba(20,184,166,.35);
      background: rgba(20,184,166,.06);
    }

    .navBtn.active {
      border-color: rgba(20,184,166,.55);
      background: linear-gradient(180deg, rgba(20,184,166,.12), rgba(255,255,255,.03));
      box-shadow: 0 0 0 3px rgba(20,184,166,.10);
    }

    .navLeft {
      display: grid;
      gap: 2px;
    }

    .navName {
      font-weight: 700;
      font-size: 14px;
      letter-spacing: .02em;
    }

    .navHint {
      font-size: 12px;
      color: var(--muted);
    }

    .pill {
      font-size: 11px;
      color: rgba(255,255,255,.78);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .sideBottom {
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .statusPill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: rgba(255,255,255,.85);
    }

    .statusDot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
      box-shadow: none;
    }
    .statusDot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34,197,94,.10), 0 0 18px rgba(34,197,94,.25);
    }
    .statusDot.err {
      background: #ef4444;
      box-shadow: 0 0 0 6px rgba(239,68,68,.10), 0 0 18px rgba(239,68,68,.25);
    }

    .clockMini {
      font-variant-numeric: tabular-nums;
      color: rgba(255,255,255,.78);
      font-size: 12px;
      letter-spacing: .02em;
      white-space: nowrap;
    }

    /* Main */
    .main {
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
      min-width: 0;
      backdrop-filter: blur(14px);
    }

    .topbar {
      padding: 18px 22px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }

    .titleWrap {
      display: grid;
      gap: 4px;
      min-width: 0;
    }

    .h1 {
      font-size: 34px;
      letter-spacing: .02em;
      font-weight: 900;
      margin: 0;
      line-height: 1.08;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subline {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .subline .sep { opacity: .35; }

    .topRight {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 9px 12px;
      font-size: 12px;
      color: rgba(255,255,255,.85);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .chip strong { font-variant-numeric: tabular-nums; }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(20,184,166,.35);
      background: rgba(20,184,166,.10);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); border-color: rgba(20,184,166,.55); background: rgba(20,184,166,.14); }

    .content {
      height: 100%;
      overflow: hidden;
      padding: 18px 22px 22px;
      box-sizing: border-box;
      display: grid;
      gap: var(--gap);
      align-content: start;
    }

    /* Panels */
    .grid3 {
      display: grid;
      grid-template-columns: 1.2fr .8fr 1.2fr;
      gap: var(--gap);
    }

    .panel {
      border-radius: var(--r-xl);
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
      overflow: hidden;
      min-width: 0;
    }

    .panelHead {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
    }

    .panelTitle {
      font-weight: 800;
      letter-spacing: .14em;
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(255,255,255,.82);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .panelBody { padding: 16px; }

    .kpiLabel {
      font-size: 13px;
      color: rgba(255,255,255,.78);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .kpiValue {
      font-variant-numeric: tabular-nums;
      font-size: 44px;
      font-weight: 900;
      letter-spacing: .01em;
      color: rgba(20,184,166,.98);
      text-shadow: 0 0 26px rgba(20,184,166,.18);
      line-height: 1;
    }

    .badge {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.78);
      white-space: nowrap;
    }

    .badge.live {
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.08);
      color: rgba(255,255,255,.88);
    }

    /* Chart panel (no scrolling) */
    .chartWrap {
      height: 340px;
      padding: 14px 16px 18px;
      box-sizing: border-box;
    }
    canvas { display:block; width:100% !important; height:100% !important; }

    /* Tables (no scrolling): we show compact rows only */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      color: rgba(255,255,255,.86);
      table-layout: fixed;
    }

    .table th {
      text-align: left;
      font-size: 10px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(255,255,255,.55);
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .table td {
      padding: 11px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-variant-numeric: tabular-nums;
    }

    .table tr:last-child td { border-bottom: 0; }

    .muted { color: rgba(255,255,255,.62); }

    .split2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items: start;
    }

    .note {
      padding: 16px;
      border-radius: var(--r-xl);
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(20,184,166,.08), rgba(255,255,255,.03));
      color: rgba(255,255,255,.85);
      line-height: 1.45;
      box-shadow: 0 14px 44px rgba(0,0,0,.28);
    }
    .note h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .note a {
      color: rgba(20,184,166,.95);
      text-decoration: none;
      border-bottom: 1px solid rgba(20,184,166,.35);
    }
    .note a:hover { border-bottom-color: rgba(20,184,166,.75); }

    /* Tabs */
    .view { display: none; height: 100%; overflow: hidden; }
    .view.active { display: grid; gap: var(--gap); }

    /* Responsive without introducing scroll */
    @media (max-width: 1100px){
      .app { grid-template-columns: 1fr; }
      .side { display: none; }
      .grid3 { grid-template-columns: 1fr; }
      .split2 { grid-template-columns: 1fr; }
      .chartWrap { height: 300px; }
    }

    @media (max-height: 820px){
      .h1 { font-size: 30px; }
      .kpiValue { font-size: 40px; }
      .chartWrap { height: 300px; }
    }

    @media (max-height: 740px){
      .chartWrap { height: 270px; }
      .kpiValue { font-size: 36px; }
      .panelBody { padding: 14px; }
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="grain"></div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="side">
      <div class="sideTop">
        <div class="brandRow">
          <div class="dot"></div>
          <div>
            <div class="brandTitle">PROFREELANCE OS</div>
            <div class="brandSub">Control Panel</div>
          </div>
        </div>
      </div>

      <div class="nav">
        <div class="navBtn active" data-view="overview">
          <div class="navLeft">
            <div class="navName">Overview</div>
            <div class="navHint">KPIs</div>
          </div>
          <div class="pill">Live</div>
        </div>

        <div class="navBtn" data-view="signal">
          <div class="navLeft">
            <div class="navName">Signal</div>
            <div class="navHint">Chart</div>
          </div>
          <div class="pill">Trend</div>
        </div>

        <div class="navBtn" data-view="pipeline">
          <div class="navLeft">
            <div class="navName">Pipeline</div>
            <div class="navHint">Deals</div>
          </div>
          <div class="pill" id="pipelineCountPill">0</div>
        </div>

        <div class="navBtn" data-view="activity">
          <div class="navLeft">
            <div class="navName">Activity</div>
            <div class="navHint">Log</div>
          </div>
          <div class="pill" id="activityCountPill">0</div>
        </div>

        <div class="navBtn" data-view="settings">
          <div class="navLeft">
            <div class="navName">Settings</div>
            <div class="navHint">Info</div>
          </div>
          <div class="pill">About</div>
        </div>
      </div>

      <div class="sideBottom">
        <div class="statusPill" id="statusPill">
          <span class="statusDot" id="statusDot"></span>
          <span id="statusText">Connecting…</span>
        </div>
        <div class="clockMini" id="clockMini">--:--</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="titleWrap">
          <h1 class="h1" id="companyTitle">PROFREELANCE OS</h1>
          <div class="subline">
            <span>Live control panel</span>
            <span class="sep">•</span>
            <span id="lastGoodSync">last good sync --</span>
          </div>
        </div>

        <div class="topRight">
          <div class="chip">
            Refresh <strong id="refreshEvery">60s</strong>
          </div>
          <div class="chip">
            Local time <strong id="clockTop">--:--:--</strong>
          </div>
          <button class="btn" id="btnRefresh">Refresh now</button>
        </div>
      </div>

      <div class="content">

        <!-- OVERVIEW -->
        <section class="view active" id="view-overview">
          <div class="grid3">
            <div class="panel">
              <div class="panelHead">
                <div class="panelTitle">Revenue</div>
                <div class="badge">ZAR</div>
              </div>
              <div class="panelBody">
                <div class="kpiLabel">
                  <span class="muted">Current</span>
                  <span class="badge" id="revUpdated">--</span>
                </div>
                <div class="kpiValue" id="kpiRevenue">R0</div>
              </div>
            </div>

            <div class="panel">
              <div class="panelHead">
                <div class="panelTitle">Active Clients</div>
                <div class="badge live">LIVE</div>
              </div>
              <div class="panelBody">
                <div class="kpiLabel">
                  <span class="muted">Current</span>
                  <span class="badge" id="clientsUpdated">--</span>
                </div>
                <div class="kpiValue" id="kpiClients">0</div>
              </div>
            </div>

            <div class="panel">
              <div class="panelHead">
                <div class="panelTitle">Pipeline Value</div>
                <div class="badge">ZAR</div>
              </div>
              <div class="panelBody">
                <div class="kpiLabel">
                  <span class="muted">Current</span>
                  <span class="badge" id="pipeUpdated">--</span>
                </div>
                <div class="kpiValue" id="kpiPipeline">R0</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div class="panelTitle">Signal</div>
              <div class="badge" id="signalRange">--</div>
            </div>
            <div class="chartWrap">
              <canvas id="signalChart"></canvas>
            </div>
          </div>
        </section>

        <!-- SIGNAL -->
        <section class="view" id="view-signal">
          <div class="panel">
            <div class="panelHead">
              <div class="panelTitle">Signal Trend</div>
              <div class="badge" id="signalRange2">--</div>
            </div>
            <div class="chartWrap">
              <canvas id="signalChart2"></canvas>
            </div>
          </div>

          <div class="split2">
            <div class="panel">
              <div class="panelHead">
                <div class="panelTitle">Latest Point</div>
                <div class="badge">Snapshot</div>
              </div>
              <div class="panelBody" id="latestPoint">
                <div class="muted">Loading…</div>
              </div>
            </div>

            <div class="panel">
              <div class="panelHead">
                <div class="panelTitle">Notes</div>
                <div class="badge">Auto</div>
              </div>
              <div class="panelBody">
                <div class="muted" style="line-height:1.5">
                  Signal is pulled live from your Google Sheet. This view is intentionally scroll-free for clean embeds.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- PIPELINE -->
        <section class="view" id="view-pipeline">
          <div class="panel">
            <div class="panelHead">
              <div class="panelTitle">Pipeline</div>
              <div class="badge" id="pipelineCountBadge">0 deal(s)</div>
            </div>
            <div class="panelBody">
              <table class="table" id="pipelineTable">
                <thead>
                  <tr>
                    <th style="width:26%">Client</th>
                    <th style="width:14%">Deal Value</th>
                    <th style="width:16%">Stage</th>
                    <th style="width:12%">Prob.</th>
                    <th style="width:16%">Weighted</th>
                    <th style="width:16%">Expected Close</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td class="muted" colspan="6">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ACTIVITY -->
        <section class="view" id="view-activity">
          <div class="panel">
            <div class="panelHead">
              <div class="panelTitle">Activity</div>
              <div class="badge" id="activityCountBadge">0 log(s)</div>
            </div>
            <div class="panelBody">
              <table class="table" id="activityTable">
                <thead>
                  <tr>
                    <th style="width:14%">Date</th>
                    <th style="width:18%">Client</th>
                    <th style="width:18%">Event</th>
                    <th style="width:12%">Type</th>
                    <th style="width:14%">Owner</th>
                    <th style="width:24%">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td class="muted" colspan="6">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div class="panelTitle">Revenue Ledger</div>
              <div class="badge" id="revenueCountBadge">0 row(s)</div>
            </div>
            <div class="panelBody">
              <table class="table" id="revenueTable">
                <thead>
                  <tr>
                    <th style="width:14%">Date</th>
                    <th style="width:22%">Client</th>
                    <th style="width:12%">Amount</th>
                    <th style="width:14%">Status</th>
                    <th style="width:14%">Invoice</th>
                    <th style="width:24%">Paid Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td class="muted" colspan="6">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section class="view" id="view-settings">
          <div class="note">
            <h3>Built by Profreelance</h3>
            <div>
              Want an OS-grade command centre that matches your workflows?
              <br><br>
              <a href="https://www.profreelance.co.za/" target="_blank" rel="noopener noreferrer">https://www.profreelance.co.za/</a>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div class="panelTitle">System</div>
              <div class="badge">Health</div>
            </div>
            <div class="panelBody" id="systemInfo" style="line-height:1.6">
              <div class="muted">Loading…</div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <script>
    // ===== CONFIG =====
    const BRAND = {
      COMPANY_NAME: "PROFREELANCE OS",
      ACCENT: "#14b8a6",
      REFRESH_SECONDS: 60
    };

    const FEEDS = {
      metrics: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=44313312&single=true&output=csv",
      signal:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=584175548&single=true&output=csv",
      pipeline:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=182871929&single=true&output=csv",
      activity:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=64013084&single=true&output=csv"
    };

    // ===== HELPERS =====
    const $ = (s) => document.querySelector(s);

    const fmtInt = (n) => {
      const x = Number(n || 0);
      return x.toLocaleString("en-ZA", { maximumFractionDigits: 0 });
    };

    const fmtZAR = (n) => {
      const x = Number(n || 0);
      return "R" + x.toLocaleString("en-ZA", { maximumFractionDigits: 0 });
    };

    function parseCSV(text) {
      // basic CSV parser with quoted support
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === "," && !inQuotes) { row.push(cur.trim()); cur = ""; continue; }
        if ((c === "\n" || c === "\r") && !inQuotes) {
          if (cur.length || row.length) row.push(cur.trim());
          cur = "";
          if (row.length) rows.push(row);
          row = [];
          continue;
        }
        cur += c;
      }
      if (cur.length || row.length) { row.push(cur.trim()); rows.push(row); }

      const header = (rows.shift() || []).map(h => (h || "").trim());
      const data = rows
        .filter(r => r.some(cell => (cell || "").trim() !== ""))
        .map(r => {
          const obj = {};
          header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });

      return data;
    }

    async function fetchCSV(url) {
      const cacheBust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url + cacheBust, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
      const text = await res.text();
      return parseCSV(text);
    }

    function setStatus(ok, message) {
      const dot = $("#statusDot");
      const txt = $("#statusText");
      dot.classList.remove("ok", "err");
      dot.classList.add(ok ? "ok" : "err");
      txt.textContent = message;
    }

    function setLastGoodSync(ts) {
      $("#lastGoodSync").textContent = ts ? `last good sync ${ts}` : "last good sync --";
    }

    function timeHHMM() {
      const d = new Date();
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function timeHHMMSS() {
      const d = new Date();
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function shortDate(d) {
      if (!d) return "--";
      return String(d).replaceAll("-", "/");
    }

    function safeNum(x) {
      if (x === null || x === undefined) return 0;
      const s = String(x).replace(/[^0-9.\-]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    function animateNumber(el, to, formatter, ms = 650) {
      const start = performance.now();
      const from = safeNum(el.dataset.val || 0);
      const delta = to - from;
      el.dataset.val = String(to);

      const step = (t) => {
        const p = Math.min(1, (t - start) / ms);
        const eased = 1 - Math.pow(1 - p, 3);
        const v = from + delta * eased;
        el.textContent = formatter(v);
        if (p < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    // ===== NAV =====
    document.querySelectorAll(".navBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".navBtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const view = btn.dataset.view;
        document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
        document.querySelector("#view-" + view).classList.add("active");
      });
    });

    // ===== CHARTS =====
    let chart1 = null;
    let chart2 = null;

    function buildSignalChart(ctx, labels, revenue, pipeline, clients) {
      const gridColor = "rgba(255,255,255,.07)";
      const tickColor = "rgba(255,255,255,.55)";

      return new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Revenue (ZAR)",
              data: revenue,
              borderColor: BRAND.ACCENT,
              backgroundColor: "rgba(20,184,166,.14)",
              borderWidth: 2,
              pointRadius: 2,
              pointHoverRadius: 4,
              tension: 0.35,
              yAxisID: "yMoney"
            },
            {
              label: "Pipeline (ZAR)",
              data: pipeline,
              borderColor: "rgba(20,184,166,.55)",
              backgroundColor: "rgba(20,184,166,.08)",
              borderWidth: 2,
              pointRadius: 2,
              pointHoverRadius: 4,
              tension: 0.35,
              yAxisID: "yMoney"
            },
            {
              label: "Clients",
              data: clients,
              borderColor: "rgba(255,255,255,.55)",
              backgroundColor: "rgba(255,255,255,.06)",
              borderWidth: 2,
              pointRadius: 2,
              pointHoverRadius: 4,
              tension: 0.35,
              yAxisID: "yClients"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              labels: { color: tickColor, boxWidth: 18, boxHeight: 8, usePointStyle: false }
            },
            tooltip: {
              caretSize: 0,
              caretPadding: 0,
              backgroundColor: "rgba(10,12,18,.92)",
              borderColor: "rgba(255,255,255,.12)",
              borderWidth: 1,
              titleColor: "rgba(255,255,255,.92)",
              bodyColor: "rgba(255,255,255,.86)",
              callbacks: {
                label: (ctx) => {
                  const label = ctx.dataset.label || "";
                  const v = ctx.parsed.y;
                  if (label.includes("(ZAR)")) return `${label}: ${fmtZAR(v)}`;
                  return `${label}: ${fmtInt(v)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: gridColor },
              ticks: { color: tickColor, maxRotation: 0, autoSkip: true }
            },
            yMoney: {
              position: "left",
              grid: { color: gridColor },
              ticks: {
                color: tickColor,
                callback: (v) => {
                  const n = Number(v);
                  if (n >= 1000000) return (n/1000000).toFixed(1) + "M";
                  if (n >= 1000) return (n/1000).toFixed(0) + "K";
                  return String(n);
                }
              }
            },
            yClients: {
              position: "right",
              grid: { drawOnChartArea: false },
              ticks: { color: tickColor }
            }
          }
        }
      });
    }

    // ===== RENDERERS =====
    function renderPipeline(rows) {
      const tbody = $("#pipelineTable tbody");
      if (!rows.length) {
        tbody.innerHTML = `<tr><td class="muted" colspan="6">No deals found.</td></tr>`;
        $("#pipelineCountBadge").textContent = "0 deal(s)";
        $("#pipelineCountPill").textContent = "0";
        return;
      }

      $("#pipelineCountBadge").textContent = `${rows.length} deal(s)`;
      $("#pipelineCountPill").textContent = String(rows.length);

      // No scrolling: show up to 6 rows
      const shown = rows.slice(0, 6);

      tbody.innerHTML = shown.map(r => {
        const client = r["Client"] || r["client"] || "";
        const deal = fmtZAR(safeNum(r["Deal Value"] || r["DealValue"] || r["Deal"]));
        const stage = r["Stage"] || "";
        const prob = safeNum(r["Probability"] || r["Prob."] || r["Prob"] || r["probability"]).toFixed(2);
        const weighted = fmtZAR(safeNum(r["Weighted Value"] || r["Weighted"] || r["WeightedValue"]));
        const close = r["Expected Close"] || r["ExpectedClose"] || r["Close"] || "";
        return `
          <tr>
            <td title="${client}">${client}</td>
            <td>${deal}</td>
            <td title="${stage}">${stage}</td>
            <td>${prob}</td>
            <td>${weighted}</td>
            <td title="${close}">${close}</td>
          </tr>
        `;
      }).join("");
    }

    function renderActivity(rows) {
      const tbody = $("#activityTable tbody");
      if (!rows.length) {
        tbody.innerHTML = `<tr><td class="muted" colspan="6">No activity found.</td></tr>`;
        $("#activityCountBadge").textContent = "0 log(s)";
        $("#activityCountPill").textContent = "0";
        return;
      }

      $("#activityCountBadge").textContent = `${rows.length} log(s)`;
      $("#activityCountPill").textContent = String(rows.length);

      // No scrolling: show up to 6 rows
      const shown = rows.slice(0, 6);

      tbody.innerHTML = shown.map(r => {
        const date = r["Date"] || r["date"] || "";
        const client = r["Client"] || "";
        const event = r["Event"] || "";
        const type  = r["Type"] || "";
        const owner = r["Owner"] || "";
        const notes = r["Notes"] || "";
        return `
          <tr>
            <td>${date}</td>
            <td title="${client}">${client}</td>
            <td title="${event}">${event}</td>
            <td>${type}</td>
            <td title="${owner}">${owner}</td>
            <td title="${notes}">${notes}</td>
          </tr>
        `;
      }).join("");
    }

    function renderRevenueLedger(rows) {
      const tbody = $("#revenueTable tbody");
      $("#revenueCountBadge").textContent = `${rows.length} row(s)`;

      if (!rows.length) {
        tbody.innerHTML = `<tr><td class="muted" colspan="6">No revenue rows found.</td></tr>`;
        return;
      }

      const shown = rows.slice(0, 6);

      tbody.innerHTML = shown.map(r => {
        const date = r["Date"] || "";
        const client = r["Client"] || "";
        const amount = fmtZAR(safeNum(r["Amount"] || r["Value"]));
        const status = r["Status"] || "";
        const inv = r["Invoice #"] || r["Invoice"] || r["Invoice#"] || "";
        const paid = r["Paid Date"] || r["PaidDate"] || "";
        return `
          <tr>
            <td>${date}</td>
            <td title="${client}">${client}</td>
            <td>${amount}</td>
            <td>${status}</td>
            <td title="${inv}">${inv}</td>
            <td title="${paid}">${paid}</td>
          </tr>
        `;
      }).join("");
    }

    // ===== LOAD + UPDATE =====
    let lastGood = null;
    let refreshTimer = null;

    async function loadAll() {
      try {
        setStatus(true, "Connecting…");

        const [metricsRows, signalRows, pipelineRows, activityRows] = await Promise.all([
          fetchCSV(FEEDS.metrics),
          fetchCSV(FEEDS.signal),
          fetchCSV(FEEDS.pipeline),
          fetchCSV(FEEDS.activity),
        ]);

        // METRICS -> KPI
        const metricMap = {};
        for (const r of metricsRows) {
          const key = (r["Metric"] || r["metric"] || "").trim();
          metricMap[key] = r;
        }

        const rev = safeNum(metricMap["Revenue"]?.Value);
        const clients = safeNum(metricMap["Active Clients"]?.Value);
        const pipe = safeNum(metricMap["Pipeline Value"]?.Value);

        animateNumber($("#kpiRevenue"), rev, (v) => fmtZAR(v));
        animateNumber($("#kpiClients"), clients, (v) => fmtInt(v));
        animateNumber($("#kpiPipeline"), pipe, (v) => fmtZAR(v));

        $("#revUpdated").textContent = metricMap["Revenue"]?.["Last Updated"] || "--";
        $("#clientsUpdated").textContent = metricMap["Active Clients"]?.["Last Updated"] || "--";
        $("#pipeUpdated").textContent = metricMap["Pipeline Value"]?.["Last Updated"] || "--";

        // SIGNAL -> chart data
        const labels = signalRows.map(r => (r["Date"] || r["date"] || "").trim());
        const sRevenue = signalRows.map(r => safeNum(r["Revenue (ZAR)"] || r["Revenue"]));
        const sPipeline = signalRows.map(r => safeNum(r["Pipeline (ZAR)"] || r["Pipeline"]));
        const sClients = signalRows.map(r => safeNum(r["Clients"] || r["clients"]));

        const range = labels.length ? `${shortDate(labels[0])} → ${shortDate(labels[labels.length - 1])}` : "--";
        $("#signalRange").textContent = range;
        $("#signalRange2").textContent = range;

        // Latest point card
        if (labels.length) {
          const i = labels.length - 1;
          $("#latestPoint").innerHTML = `
            <div style="display:grid; gap:10px">
              <div class="muted" style="letter-spacing:.12em; text-transform:uppercase; font-size:11px">Latest</div>
              <div style="display:grid; gap:6px">
                <div><span class="muted">Date:</span> <strong>${labels[i]}</strong></div>
                <div><span class="muted">Revenue:</span> <strong style="color:rgba(20,184,166,.95)">${fmtZAR(sRevenue[i])}</strong></div>
                <div><span class="muted">Pipeline:</span> <strong style="color:rgba(20,184,166,.95)">${fmtZAR(sPipeline[i])}</strong></div>
                <div><span class="muted">Clients:</span> <strong>${fmtInt(sClients[i])}</strong></div>
              </div>
            </div>
          `;
        } else {
          $("#latestPoint").innerHTML = `<div class="muted">No signal data found.</div>`;
        }

        // Render charts (two canvases)
        if (chart1) chart1.destroy();
        if (chart2) chart2.destroy();
        chart1 = buildSignalChart($("#signalChart"), labels, sRevenue, sPipeline, sClients);
        chart2 = buildSignalChart($("#signalChart2"), labels, sRevenue, sPipeline, sClients);

        // Pipeline + Activity
        renderPipeline(pipelineRows);
        renderActivity(activityRows);

        // Revenue ledger comes from "Revenue" tab, but your CSV list doesn’t include it separately.
        // If you want it live too, publish the Revenue tab as CSV and paste it here.
        // For now we keep it empty and clean to avoid fake data.
        renderRevenueLedger([]);

        // System info
        $("#systemInfo").innerHTML = `
          <div><span class="muted">Feeds:</span> Metrics, Signal, Pipeline, Activity</div>
          <div><span class="muted">Refresh:</span> Every ${BRAND.REFRESH_SECONDS}s</div>
          <div><span class="muted">Last sync:</span> ${timeHHMMSS()}</div>
        `;

        lastGood = timeHHMMSS();
        setLastGoodSync(lastGood);
        setStatus(true, "Connected");
      } catch (err) {
        console.error(err);
        setStatus(false, "Error");
        // keep lastGoodSync as-is, don’t wipe it
      }
    }

    function startRefreshLoop() {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(loadAll, BRAND.REFRESH_SECONDS * 1000);
    }

    // ===== CLOCK =====
    function tickClock(){
      $("#clockMini").textContent = timeHHMM();
      $("#clockTop").textContent = timeHHMMSS();
    }
    setInterval(tickClock, 250);
    tickClock();

    // ===== INIT =====
    $("#companyTitle").textContent = BRAND.COMPANY_NAME;
    $("#refreshEvery").textContent = BRAND.REFRESH_SECONDS + "s";

    $("#btnRefresh").addEventListener("click", () => loadAll());

    loadAll();
    startRefreshLoop();
  </script>
</body>
</html>
