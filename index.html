<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PROFREELANCE OS CONTROL PANEL</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#05070f;
      --bg1:#070a14;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.42);
      --teal:#14b8a6;
      --teal2:#00ffd0;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --glow: 0 0 0 1px rgba(20,184,166,.18), 0 0 38px rgba(20,184,166,.12);
      --r: 18px;
      --r2: 26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(20,184,166,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(0,255,208,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(20,184,166,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* lightweight animated grid (no click blocking) */
    .bg-grid{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.18;
      background-image:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 44px 44px;
      mask-image: radial-gradient(circle at 30% 20%, black 0%, transparent 65%);
      animation: drift 18s linear infinite;
      z-index:0;
    }
    @keyframes drift{
      0%{ transform: translate3d(0,0,0); }
      50%{ transform: translate3d(18px, 10px,0); }
      100%{ transform: translate3d(0,0,0); }
    }

    .app{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      position:sticky; top:0;
      height:100vh;
      padding:20px 16px;
      border-right: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.08));
      backdrop-filter: blur(14px);
      z-index:2;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      padding:14px 14px;
      border-radius: var(--r2);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--glow);
    }
    .brand .dot{
      width:12px; height:12px; border-radius:999px;
      background: var(--teal);
      box-shadow: 0 0 0 6px rgba(20,184,166,.14), 0 0 26px rgba(20,184,166,.35);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(255,255,255,.88);
      line-height:1.15;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .nav{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:6px 2px;
    }
    .nav a{
      text-decoration:none;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: transparent;
      transition: .18s ease;
      cursor:pointer;
    }
    .nav a:hover{
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.07);
    }
    .nav a.active{
      color: rgba(255,255,255,.94);
      background: rgba(20,184,166,.10);
      border-color: rgba(20,184,166,.22);
      box-shadow: 0 0 0 1px rgba(20,184,166,.10);
    }
    .nav .pill{
      font-family: var(--mono);
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.70);
      background: rgba(255,255,255,.03);
    }

    .sidebar-footer{
      position:absolute;
      left:16px; right:16px;
      bottom:16px;
      padding:12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .sidebar-footer .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .status{
      display:flex; align-items:center; gap:10px;
      font-size:12px;
      color: var(--muted);
    }
    .led{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow:none;
      flex:0 0 auto;
    }
    .led.connected{
      background: var(--teal);
      box-shadow: 0 0 0 6px rgba(20,184,166,.14), 0 0 18px rgba(20,184,166,.35);
    }
    .led.degraded{
      background: #fbbf24;
      box-shadow: 0 0 0 6px rgba(251,191,36,.14), 0 0 18px rgba(251,191,36,.30);
    }
    .led.error{
      background: #fb7185;
      box-shadow: 0 0 0 6px rgba(251,113,133,.14), 0 0 18px rgba(251,113,133,.30);
    }
    .mini{
      font-family: var(--mono);
      font-size:12px;
      color: var(--muted);
    }

    /* Main */
    .main{
      padding:24px;
      max-width: 1240px;
      width:100%;
      margin:0 auto;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .title h2{
      margin:0;
      font-size:38px;
      letter-spacing:.02em;
    }
    .title .sub{
      margin-top:8px;
      color: var(--muted);
      font-size:12px;
      font-family: var(--mono);
    }
    .top-widgets{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.78);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .chip b{
      color: rgba(255,255,255,.92);
      font-family: var(--mono);
      font-weight:600;
      font-size:12px;
    }
    .clock{
      font-family: var(--mono);
      font-size:12px;
      letter-spacing:.04em;
    }

    /* Sections must be scroll targets with spacing */
    section{ scroll-margin-top: 20px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      margin-top: 10px;
    }

    .card{
      grid-column: span 12;
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 200px at 20% 0%, rgba(20,184,166,.18), transparent 65%);
      pointer-events:none;
      opacity:.75;
    }
    .card-inner{ position:relative; padding:18px; }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin:0 0 10px;
    }
    .section-title h3{
      margin:0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(255,255,255,.82);
    }

    /* KPIs */
    .kpis{
      grid-column: span 12;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      margin-bottom:14px;
    }
    .kpi{
      grid-column: span 12;
      padding:18px;
      border-radius: var(--r2);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--glow);
      position:relative;
      overflow:hidden;
      min-height: 112px;
    }
    .kpi::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(420px 180px at 20% 0%, rgba(20,184,166,.16), transparent 60%);
      opacity:.7;
      pointer-events:none;
    }
    .kpi .k-title{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.80);
      font-size:13px;
      margin-bottom:10px;
    }
    .badge{
      font-family: var(--mono);
      font-size:11px;
      padding:4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,184,166,.22);
      background: rgba(20,184,166,.10);
      color: rgba(255,255,255,.85);
    }
    .kpi .k-value{
      position:relative;
      font-size:44px;
      letter-spacing:.01em;
      color: var(--teal2);
      text-shadow: 0 0 28px rgba(0,255,208,.20);
      font-weight:650;
      line-height:1.05;
      white-space:nowrap;
    }

    @media (min-width: 920px){
      .kpi{ grid-column: span 4; }
    }

    /* Chart */
    .chart-wrap{ height: 340px; }
    canvas{ display:block; width:100% !important; height:100% !important; }

    /* Tables */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      padding:12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
    }
    tbody td{
      padding:12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover td{ background: rgba(20,184,166,.06); }
    tbody tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }
    .muted{ color: var(--muted); }

    .two-col{
      grid-column: span 12;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 1024px){
      .two-col{ grid-template-columns: 1.08fr .92fr; }
    }

    /* Settings note */
    .note{
      padding:14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .note h4{
      margin:0 0 8px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,255,255,.80);
    }
    .note p{
      margin:0;
      color: var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .note a{
      color: rgba(255,255,255,.90);
      text-decoration:none;
      border-bottom: 1px solid rgba(20,184,166,.35);
    }
    .note a:hover{
      border-bottom-color: rgba(0,255,208,.65);
    }

    /* Mobile */
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{
        position:relative;
        height:auto;
        border-right:none;
        border-bottom: 1px solid rgba(255,255,255,.06);
      }
      .sidebar-footer{ position:relative; left:auto; right:auto; bottom:auto; margin-top:12px; }
    }
  </style>
</head>

<body>
  <div class="bg-grid"></div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>PROFREELANCE OS</h1>
          <p>Control Panel</p>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="#overview" class="active"><span>Overview</span><span class="pill">KPIs</span></a>
        <a href="#signal"><span>Signal</span><span class="pill">Chart</span></a>
        <a href="#pipeline"><span>Pipeline</span><span class="pill">Table</span></a>
        <a href="#activity"><span>Activity</span><span class="pill">Log</span></a>
        <a href="#settings"><span>Settings</span><span class="pill">Info</span></a>
      </nav>

      <div class="sidebar-footer">
        <div class="row">
          <div class="status">
            <span class="led" id="led"></span>
            <span id="statusText">Loading…</span>
          </div>
          <div class="mini" id="lastSync">—</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2>PROFREELANCE OS</h2>
          <div class="sub" id="subline">Live control panel</div>
        </div>

        <div class="top-widgets">
          <div class="chip"><span class="muted">Refresh</span><b id="refreshRate">60s</b></div>
          <div class="chip"><span class="muted">Local time</span><span class="clock" id="clock">—</span></div>
        </div>
      </div>

      <!-- OVERVIEW -->
      <section id="overview" class="kpis">
        <div class="kpi">
          <div class="k-title"><span>Revenue</span><span class="badge">ZAR</span></div>
          <div class="k-value" id="kpiRevenue">—</div>
        </div>

        <div class="kpi">
          <div class="k-title"><span>Active Clients</span><span class="badge">LIVE</span></div>
          <div class="k-value" id="kpiClients">—</div>
        </div>

        <div class="kpi">
          <div class="k-title"><span>Pipeline Value</span><span class="badge">ZAR</span></div>
          <div class="k-value" id="kpiPipeline">—</div>
        </div>
      </section>

      <div class="grid">
        <!-- SIGNAL -->
        <section id="signal" class="card">
          <div class="card-inner">
            <div class="section-title">
              <h3>Signal</h3>
              <div class="mini" id="signalMeta">—</div>
            </div>
            <div class="chart-wrap">
              <canvas id="signalChart"></canvas>
            </div>
          </div>
        </section>

        <div class="two-col">
          <!-- PIPELINE -->
          <section id="pipeline" class="card">
            <div class="card-inner">
              <div class="section-title">
                <h3>Pipeline</h3>
                <div class="mini" id="pipelineMeta">—</div>
              </div>
              <div style="overflow:auto; border-radius:16px; max-height:360px;">
                <table>
                  <thead>
                    <tr>
                      <th>Client</th>
                      <th class="right">Deal Value</th>
                      <th>Stage</th>
                      <th class="right">Prob.</th>
                      <th class="right">Weighted</th>
                      <th>Expected Close</th>
                    </tr>
                  </thead>
                  <tbody id="pipelineBody">
                    <tr><td colspan="6" class="muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- ACTIVITY -->
          <section id="activity" class="card">
            <div class="card-inner">
              <div class="section-title">
                <h3>Activity</h3>
                <div class="mini" id="activityMeta">—</div>
              </div>
              <div style="overflow:auto; border-radius:16px; max-height:360px;">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Client</th>
                      <th>Event</th>
                      <th>Type</th>
                      <th>Owner</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="activityBody">
                    <tr><td colspan="6" class="muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>

        <!-- SETTINGS -->
        <section id="settings" class="card">
          <div class="card-inner">
            <div class="section-title">
              <h3>Settings</h3>
              <div class="mini">Build: static, free stack</div>
            </div>
            <div class="note">
              <h4>From Profreelance</h4>
              <p>
                <a href="https://www.profreelance.co.za/" target="_blank" rel="noopener noreferrer">https://www.profreelance.co.za/</a>
              </p>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== YOUR CSV LINKS (unchanged) =====
    const CSV = {
      metrics:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=44313312&single=true&output=csv",
      signal:   "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=584175548&single=true&output=csv",
      pipeline: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=182871929&single=true&output=csv",
      activity: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=64013084&single=true&output=csv"
    };

    const REFRESH_MS = 60000;          // 60s
    const MAX_FAILS_FOR_ERROR = 4;     // avoid annoying flip
    const CACHE_BUST = true;

    const el = (id) => document.getElementById(id);

    // ===== Formatting (handles commas + currency symbols if they ever appear) =====
    const toNumber = (v) => {
      if (v === null || v === undefined) return NaN;
      const s = String(v).replace(/[^\d.-]/g, ""); // strips R, commas, spaces
      return Number(s);
    };
    const fmtZar = (n) => isFinite(n) ? ("R" + n.toLocaleString("en-ZA", { maximumFractionDigits: 0 })) : "—";
    const fmtInt = (n) => isFinite(n) ? n.toLocaleString("en-ZA", { maximumFractionDigits: 0 }) : "—";
    const safe = (v) => (v ?? "").toString().trim();

    // ===== Robust CSV parser (quotes + commas safe) =====
    function parseCSV(text){
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const c = text[i];
        const n = text[i+1];

        if (c === '"' && inQuotes && n === '"'){ field += '"'; i++; continue; }
        if (c === '"'){ inQuotes = !inQuotes; continue; }

        if (c === ',' && !inQuotes){
          row.push(field); field = ""; continue;
        }

        if ((c === '\n' || c === '\r') && !inQuotes){
          if (c === '\r' && n === '\n') i++;
          row.push(field); field = "";
          if (row.some(x => x !== "")) rows.push(row);
          row = [];
          continue;
        }

        field += c;
      }

      row.push(field);
      if (row.some(x => x !== "")) rows.push(row);

      if (!rows.length) return { headers: [], data: [] };

      const headers = rows[0].map(h => h.trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });

      return { headers, data };
    }

    async function fetchCSV(url){
      const u = CACHE_BUST ? (url + (url.includes("?") ? "&" : "?") + "t=" + Date.now()) : url;
      const res = await fetch(u, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();
      return parseCSV(text);
    }

    // ===== Connection state =====
    const led = el("led");
    const statusText = el("statusText");
    const lastSync = el("lastSync");
    const refreshRate = el("refreshRate");
    refreshRate.textContent = Math.round(REFRESH_MS/1000) + "s";

    let lastOkAt = 0;
    let consecutiveFails = 0;

    function setStatus(state, detail){
      led.className = "led " + state;
      statusText.textContent =
        state === "connected" ? "Connected" :
        state === "degraded"  ? "Degraded"  :
        "Error";

      if (detail) statusText.textContent += " · " + detail;
    }

    function touchLastSync(){
      const d = new Date();
      lastSync.textContent = d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }

    // ===== Chart =====
    let signalChart;

    function buildOrUpdateSignalChart(labels, revenue, pipeline, clients){
      const ctx = el("signalChart");

      const base = {
        tension: 0.35,
        pointRadius: 3,
        pointHoverRadius: 4,
        borderWidth: 2
      };

      const data = {
        labels,
        datasets: [
          { label:"Revenue (ZAR)", data: revenue, ...base, borderColor:"#14b8a6", pointBorderColor:"#14b8a6", pointBackgroundColor:"#05070f" },
          { label:"Pipeline (ZAR)", data: pipeline, ...base, borderColor:"#00ffd0", pointBorderColor:"#00ffd0", pointBackgroundColor:"#05070f" },
          { label:"Clients", data: clients, ...base, borderColor:"rgba(255,255,255,.65)", pointBorderColor:"rgba(255,255,255,.65)", pointBackgroundColor:"#05070f", yAxisID:"y2" }
        ]
      };

      const options = {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:"index", intersect:false },
        plugins:{
          legend:{ labels:{ color:"rgba(255,255,255,.72)" } },
          tooltip:{
            backgroundColor:"rgba(10,12,22,.92)",
            borderColor:"rgba(255,255,255,.14)",
            borderWidth:1,
            titleColor:"rgba(255,255,255,.92)",
            bodyColor:"rgba(255,255,255,.86)"
          }
        },
        scales:{
          x:{ ticks:{ color:"rgba(255,255,255,.50)", maxRotation:0 }, grid:{ color:"rgba(255,255,255,.05)" } },
          y:{
            ticks:{ color:"rgba(255,255,255,.50)", callback:(v)=>Number(v).toLocaleString("en-ZA") },
            grid:{ color:"rgba(255,255,255,.05)" }
          },
          y2:{ position:"right", ticks:{ color:"rgba(255,255,255,.38)" }, grid:{ drawOnChartArea:false } }
        }
      };

      if (!signalChart){
        signalChart = new Chart(ctx, { type:"line", data, options });
      } else {
        signalChart.data = data;
        signalChart.update();
      }
    }

    // ===== Renderers =====
    function renderMetrics(metrics){
      const findValue = (name) => {
        const row = metrics.data.find(r => (r["Metric"] || "").toLowerCase() === name.toLowerCase());
        return row ? row["Value"] : "";
      };

      const revenue = toNumber(findValue("Revenue"));
      const clients = toNumber(findValue("Active Clients"));
      const pipeline = toNumber(findValue("Pipeline Value"));

      el("kpiRevenue").textContent = fmtZar(revenue);
      el("kpiClients").textContent = fmtInt(clients);
      el("kpiPipeline").textContent = fmtZar(pipeline);
    }

    function renderSignal(signal){
      const labels = signal.data.map(r => safe(r["Date"])).filter(Boolean);
      const revenue = signal.data.map(r => toNumber(r["Revenue (ZAR)"]) || 0);
      const pipeline = signal.data.map(r => toNumber(r["Pipeline (ZAR)"]) || 0);
      const clients = signal.data.map(r => toNumber(r["Clients"]) || 0);

      buildOrUpdateSignalChart(labels, revenue, pipeline, clients);

      el("signalMeta").textContent = labels.length ? (labels[0] + " → " + labels[labels.length-1]) : "—";
    }

    function renderPipeline(pipeline){
      const body = el("pipelineBody");
      body.innerHTML = "";

      if (!pipeline.data.length){
        body.innerHTML = `<tr><td colspan="6" class="muted">No pipeline rows yet.</td></tr>`;
        el("pipelineMeta").textContent = "—";
        return;
      }

      pipeline.data.forEach(r => {
        const tr = document.createElement("tr");

        const client = safe(r["Client"]);
        const deal = toNumber(r["Deal Value"]);
        const stage = safe(r["Stage"]);
        const prob = toNumber(r["Probability"]);
        const weighted = toNumber(r["Weighted Value"]);
        const close = safe(r["Expected Close"]);

        tr.innerHTML = `
          <td>${client || "—"}</td>
          <td class="right">${fmtZar(deal)}</td>
          <td class="muted">${stage || "—"}</td>
          <td class="right">${isFinite(prob) ? prob.toFixed(2) : "—"}</td>
          <td class="right">${fmtZar(weighted)}</td>
          <td class="muted">${close || "—"}</td>
        `;
        body.appendChild(tr);
      });

      el("pipelineMeta").textContent = pipeline.data.length + " deal(s)";
    }

    function renderActivity(activity){
      const body = el("activityBody");
      body.innerHTML = "";

      if (!activity.data.length){
        body.innerHTML = `<tr><td colspan="6" class="muted">No activity yet.</td></tr>`;
        el("activityMeta").textContent = "—";
        return;
      }

      activity.data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="muted">${safe(r["Date"]) || "—"}</td>
          <td>${safe(r["Client"]) || "—"}</td>
          <td>${safe(r["Event"]) || "—"}</td>
          <td class="muted">${safe(r["Type"]) || "—"}</td>
          <td class="muted">${safe(r["Owner"]) || "—"}</td>
          <td class="muted">${safe(r["Notes"]) || "—"}</td>
        `;
        body.appendChild(tr);
      });

      el("activityMeta").textContent = activity.data.length + " log(s)";
    }

    // ===== Clock =====
    function tickClock(){
      const d = new Date();
      el("clock").textContent = d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }
    setInterval(tickClock, 1000);
    tickClock();

    // ===== Sidebar: smooth scroll + active state =====
    const nav = document.getElementById("nav");
    const navLinks = Array.from(nav.querySelectorAll("a"));
    const sections = navLinks.map(a => document.querySelector(a.getAttribute("href")));

    nav.addEventListener("click", (e) => {
      const a = e.target.closest("a");
      if (!a) return;
      e.preventDefault();
      const id = a.getAttribute("href");
      const target = document.querySelector(id);
      if (target){
        target.scrollIntoView({ behavior:"smooth", block:"start" });
      }
    });

    function updateActive(){
      const y = window.scrollY + 140;
      let activeIdx = 0;
      sections.forEach((sec, i) => { if (sec && sec.offsetTop <= y) activeIdx = i; });
      navLinks.forEach((a, i) => a.classList.toggle("active", i === activeIdx));
    }
    window.addEventListener("scroll", updateActive, { passive:true });
    updateActive();

    // ===== Main refresh =====
    async function refresh(){
      try{
        const [metrics, signal, pipeline, activity] = await Promise.all([
          fetchCSV(CSV.metrics),
          fetchCSV(CSV.signal),
          fetchCSV(CSV.pipeline),
          fetchCSV(CSV.activity)
        ]);

        renderMetrics(metrics);
        renderSignal(signal);
        renderPipeline(pipeline);
        renderActivity(activity);

        consecutiveFails = 0;
        lastOkAt = Date.now();
        setStatus("connected");
        touchLastSync();

      } catch (err){
        consecutiveFails += 1;

        // If we’ve had a recent success, mark degraded first
        const secondsSinceOk = lastOkAt ? (Date.now() - lastOkAt) / 1000 : Infinity;

        if (consecutiveFails >= MAX_FAILS_FOR_ERROR && secondsSinceOk > (REFRESH_MS/1000) * 2){
          setStatus("error");
        } else {
          setStatus("degraded", "retrying");
        }
      }

      if (lastOkAt){
        const ageS = Math.floor((Date.now() - lastOkAt) / 1000);
        el("subline").textContent = "Live control panel · last good sync " + ageS + "s ago";
      }
    }

    setStatus("degraded", "booting");
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
