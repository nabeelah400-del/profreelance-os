<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PROFREELANCE OS · Control Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg:        #060810;
      --surface:   rgba(255,255,255,.055);
      --surface2:  rgba(255,255,255,.03);
      --border:    rgba(255,255,255,.09);
      --border2:   rgba(255,255,255,.13);
      --text:      rgba(255,255,255,.94);
      --muted:     rgba(255,255,255,.56);
      --muted2:    rgba(255,255,255,.36);
      --accent:    #0fffd4;
      --accent2:   #14b8a6;
      --accent-bg: rgba(15,255,212,.08);
      --accent-border: rgba(15,255,212,.20);
      --warn:      #fbbf24;
      --error:     #fb7185;
      --radius:    20px;
      --mono: "DM Mono", ui-monospace, monospace;
      --display: "Syne", system-ui, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--display);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    body::before {
      content: "";
      position: fixed; inset: 0;
      pointer-events: none;
      z-index: 0;
      opacity: .028;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      background-size: 200px 200px;
    }

    .blobs {
      position: fixed; inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .blob {
      position: absolute;
      border-radius: 999px;
      filter: blur(120px);
      opacity: .22;
      animation: breathe var(--dur, 14s) ease-in-out infinite;
    }
    .blob-1 { width: 700px; height: 400px; background: #14b8a6; top: -120px; left: -180px; --dur: 16s; }
    .blob-2 { width: 500px; height: 400px; background: #0ea5e9; top: -60px; right: -150px; --dur: 20s; animation-delay: -7s; }
    .blob-3 { width: 600px; height: 350px; background: #14b8a6; bottom: -100px; left: 30%; --dur: 18s; animation-delay: -3s; }

    @keyframes breathe {
      0%, 100% { transform: scale(1) translate(0, 0); }
      33%  { transform: scale(1.12) translate(30px, -20px); }
      66%  { transform: scale(.94) translate(-20px, 18px); }
    }

    .app {
      position: relative;
      z-index: 1;
      max-width: 980px;
      margin: 0 auto;
      padding: 20px 18px 40px;
      opacity: 0;
      transform: translateY(12px);
      animation: fadeUp .55s cubic-bezier(.22,1,.36,1) .1s forwards;
    }

    @keyframes fadeUp {
      to { opacity: 1; transform: none; }
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 22px;
      padding: 14px 18px;
      border-radius: var(--radius);
      background: var(--surface);
      border: 1px solid var(--border);
      backdrop-filter: blur(18px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .brand-icon {
      width: 34px; height: 34px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent2) 0%, var(--accent) 100%);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 0 6px rgba(15,255,212,.10), 0 0 30px rgba(15,255,212,.22);
      flex: 0 0 auto;
    }
    .brand-icon svg { width: 18px; height: 18px; }
    .brand-name {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .14em;
      text-transform: uppercase;
      line-height: 1.1;
    }
    .brand-sub {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      letter-spacing: .04em;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      display: flex; align-items: center; gap: 8px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      white-space: nowrap;
    }
    .pill b { color: rgba(255,255,255,.88); font-weight: 500; }

    .live-dot {
      width: 7px; height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(15,255,212,.18);
      animation: pulse 2.2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 3px rgba(15,255,212,.18); }
      50%       { box-shadow: 0 0 0 6px rgba(15,255,212,.06), 0 0 16px rgba(15,255,212,.35); }
    }
    .live-dot.warn  { background: var(--warn);  box-shadow: 0 0 0 3px rgba(251,191,36,.18);  animation: none; }
    .live-dot.error { background: var(--error); box-shadow: 0 0 0 3px rgba(251,113,133,.18); animation: none; }

    .section-label {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted2);
      margin: 26px 0 10px 2px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media (max-width: 560px) {
      .kpi-grid { grid-template-columns: 1fr; }
    }

    .kpi {
      padding: 20px 18px;
      border-radius: var(--radius);
      background: var(--surface);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: border-color .2s, box-shadow .2s;
    }
    .kpi:hover {
      border-color: var(--accent-border);
      box-shadow: 0 0 0 1px var(--accent-border), 0 0 32px rgba(15,255,212,.08);
    }
    .kpi::before {
      content: "";
      position: absolute; inset: 0;
      background: radial-gradient(380px 180px at 0% -10%, rgba(15,255,212,.10), transparent 55%);
      pointer-events: none;
    }
    .kpi-label {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
      position: relative;
    }
    .kpi-value {
      font-size: clamp(26px, 4vw, 38px);
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 0 24px rgba(15,255,212,.18);
      line-height: 1;
      position: relative;
      letter-spacing: -.01em;
    }
    .kpi-value.skeleton {
      color: transparent;
      background: linear-gradient(90deg, rgba(255,255,255,.07) 25%, rgba(255,255,255,.13) 50%, rgba(255,255,255,.07) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 8px;
      height: 38px;
      width: 70%;
    }
    @keyframes shimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .card {
      border-radius: var(--radius);
      background: var(--surface);
      border: 1px solid var(--border);
      overflow: hidden;
      position: relative;
      margin-top: 12px;
    }
    .card::before {
      content: "";
      position: absolute; inset: 0;
      background: radial-gradient(600px 220px at 15% -5%, rgba(15,255,212,.09), transparent 55%);
      pointer-events: none;
    }
    .card-header {
      padding: 16px 18px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
      position: relative;
    }
    .card-title {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.80);
    }
    .card-meta {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted2);
    }
    .card-body { position: relative; }

    .chart-wrap {
      height: 280px;
      padding: 16px 16px 12px;
    }
    canvas { display: block; width: 100% !important; height: 100% !important; }

    .two-col {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 720px) {
      .two-col { grid-template-columns: 1fr; }
    }

    .table-wrap {
      overflow: auto;
      max-height: 340px;
    }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 500;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted2);
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.15);
      position: sticky; top: 0;
      backdrop-filter: blur(14px);
      white-space: nowrap;
    }
    tbody td {
      padding: 10px 14px;
      font-size: 12.5px;
      color: rgba(255,255,255,.84);
      border-bottom: 1px solid rgba(255,255,255,.05);
      vertical-align: middle;
      font-family: var(--display);
    }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: rgba(15,255,212,.04); }
    .td-mono   { font-family: var(--mono); font-size: 12px; }
    .td-muted  { color: var(--muted); }
    .td-right  { text-align: right; }
    .td-accent { color: var(--accent); font-family: var(--mono); font-size: 12px; }

    .stage {
      display: inline-block;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 500;
      letter-spacing: .06em;
      text-transform: uppercase;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.72);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }
    .stage.won  { border-color: rgba(15,255,212,.30);  color: var(--accent); background: rgba(15,255,212,.08); }
    .stage.lost { border-color: rgba(251,113,133,.30); color: #fb7185;       background: rgba(251,113,133,.06); }
    .stage.hot  { border-color: rgba(251,191,36,.30);  color: #fbbf24;       background: rgba(251,191,36,.06); }

    .footer-strip {
      margin-top: 18px;
      padding: 14px 18px;
      border-radius: var(--radius);
      background: var(--surface2);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .footer-strip span { font-family: var(--mono); font-size: 11px; color: var(--muted2); }
    .footer-strip a {
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.65);
      text-decoration: none;
      border-bottom: 1px solid rgba(15,255,212,.30);
      transition: color .15s;
    }
    .footer-strip a:hover { color: var(--accent); }

    .empty {
      padding: 28px 14px;
      text-align: center;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted2);
    }
  </style>
</head>

<body>
  <div class="blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="brand-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
        </div>
        <div>
          <div class="brand-name">ProFreelance OS</div>
          <div class="brand-sub">Control Panel</div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="pill">
          <div class="live-dot" id="liveDot"></div>
          <span id="statusLabel">Loading</span>
        </div>
        <div class="pill"><span>Synced&nbsp;</span><b id="lastSync">—</b></div>
        <div class="pill"><span id="clock">—</span></div>
      </div>
    </div>

    <div class="section-label">Overview</div>
    <div class="kpi-grid">
      <div class="kpi">
        <div class="kpi-label">Revenue</div>
        <div class="kpi-value skeleton" id="kpiRevenue"></div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Active Clients</div>
        <div class="kpi-value skeleton" id="kpiClients"></div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Pipeline</div>
        <div class="kpi-value skeleton" id="kpiPipeline"></div>
      </div>
    </div>

    <div class="section-label">Signal</div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">Revenue &amp; Pipeline Trend</span>
        <span class="card-meta" id="signalMeta">—</span>
      </div>
      <div class="card-body">
        <div class="chart-wrap">
          <canvas id="signalChart"></canvas>
        </div>
      </div>
    </div>

    <div class="two-col">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Pipeline</span>
          <span class="card-meta" id="pipelineMeta">—</span>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th class="td-right">Value</th>
                  <th>Stage</th>
                  <th class="td-right">Prob</th>
                  <th class="td-right">Weighted</th>
                  <th>Close</th>
                </tr>
              </thead>
              <tbody id="pipelineBody">
                <tr><td colspan="6"><div class="empty">Loading…</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Activity Log</span>
          <span class="card-meta" id="activityMeta">—</span>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Event</th>
                  <th>Type</th>
                  <th>Owner</th>
                </tr>
              </thead>
              <tbody id="activityBody">
                <tr><td colspan="5"><div class="empty">Loading…</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-strip">
      <span id="footerStatus">Live control panel · last sync —</span>
      <a href="https://www.profreelance.co.za/" target="_blank" rel="noopener">profreelance.co.za ↗</a>
    </div>

  </div>

  <script>
    const CSV = {
      metrics:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=44313312&single=true&output=csv",
      signal:   "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=584175548&single=true&output=csv",
      pipeline: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=182871929&single=true&output=csv",
      activity: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPgSVSxvqDb3ZT4xfOdWvS7L2femGi-QM_S7yG72TkFYj7RTvRcRIakEnnpfgOXEStak3Q72Q0YBGB/pub?gid=64013084&single=true&output=csv"
    };

    const REFRESH_MS = 60_000;
    const MAX_FAILS  = 4;

    const el     = id => document.getElementById(id);
    const toNum  = v  => { const s = String(v ?? "").replace(/[^\d.-]/g, ""); return Number(s); };
    const fmtZAR = n  => isFinite(n) ? "R" + n.toLocaleString("en-ZA", { maximumFractionDigits: 0 }) : "—";
    const fmtInt = n  => isFinite(n) ? n.toLocaleString("en-ZA", { maximumFractionDigits: 0 }) : "—";
    const safe   = v  => (v ?? "").toString().trim();

    function animateCount(elem, rawValue, isZAR) {
      const target = toNum(rawValue);
      if (!isFinite(target)) { elem.textContent = "—"; return; }
      const duration = 1100;
      const start = performance.now();
      const fmt = isZAR ? fmtZAR : fmtInt;
      function step(now) {
        const p = Math.min((now - start) / duration, 1);
        const ease = 1 - Math.pow(1 - p, 3);
        elem.textContent = fmt(Math.round(ease * target));
        if (p < 1) requestAnimationFrame(step);
        else elem.textContent = fmt(target);
      }
      requestAnimationFrame(step);
    }

    function parseCSV(text) {
      const rows = [];
      let row = [], field = "", inQ = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"' && inQ && n === '"') { field += '"'; i++; continue; }
        if (c === '"') { inQ = !inQ; continue; }
        if (c === ',' && !inQ) { row.push(field); field = ""; continue; }
        if ((c === '\n' || c === '\r') && !inQ) {
          if (c === '\r' && n === '\n') i++;
          row.push(field); field = "";
          if (row.some(x => x !== "")) rows.push(row);
          row = []; continue;
        }
        field += c;
      }
      row.push(field);
      if (row.some(x => x !== "")) rows.push(row);
      if (!rows.length) return { headers: [], data: [] };
      const headers = rows[0].map(h => h.trim());
      const data = rows.slice(1).map(r => {
        const o = {};
        headers.forEach((h, i) => o[h] = (r[i] ?? "").trim());
        return o;
      });
      return { headers, data };
    }

    async function fetchCSV(url) {
      const u = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const r = await fetch(u, { cache: "no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      return parseCSV(await r.text());
    }

    const dot   = el("liveDot");
    const label = el("statusLabel");
    let fails = 0, lastOk = 0;

    function setStatus(state, note) {
      dot.className = "live-dot" + (state === "degraded" ? " warn" : state === "error" ? " error" : "");
      label.textContent = state === "connected" ? "Live" : state === "degraded" ? "Degraded" : "Error";
      if (note) label.textContent += " · " + note;
    }

    const clockEl = el("clock");
    setInterval(() => {
      clockEl.textContent = new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }, 1000);
    clockEl.textContent = new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit" });

    let chart;

    function buildChart(labels, revenue, pipeline, clients) {
      const ctx = el("signalChart").getContext("2d");
      const gradA = ctx.createLinearGradient(0, 0, 0, 260);
      gradA.addColorStop(0, "rgba(15,255,212,.18)");
      gradA.addColorStop(1, "rgba(15,255,212,0)");
      const gradB = ctx.createLinearGradient(0, 0, 0, 260);
      gradB.addColorStop(0, "rgba(14,165,233,.14)");
      gradB.addColorStop(1, "rgba(14,165,233,0)");
      const base = { tension: .42, pointRadius: 3, pointHoverRadius: 5, borderWidth: 2, fill: true };
      const data = {
        labels,
        datasets: [
          { label: "Revenue (ZAR)",  data: revenue,  ...base, borderColor: "#0fffd4", pointBackgroundColor: "#0fffd4", backgroundColor: gradA },
          { label: "Pipeline (ZAR)", data: pipeline, ...base, borderColor: "#0ea5e9", pointBackgroundColor: "#0ea5e9", backgroundColor: gradB },
          { label: "Clients", data: clients, ...base, fill: false,
            borderColor: "rgba(255,255,255,.45)", pointBackgroundColor: "rgba(255,255,255,.55)",
            borderDash: [4,4], yAxisID: "y2" }
        ]
      };
      const opts = {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { labels: { color: "rgba(255,255,255,.65)", font: { family: "DM Mono", size: 11 }, boxWidth: 12, boxHeight: 2, usePointStyle: true, pointStyle: "line" } },
          tooltip: {
            backgroundColor: "rgba(6,8,16,.95)", borderColor: "rgba(255,255,255,.12)", borderWidth: 1,
            titleColor: "rgba(255,255,255,.90)", bodyColor: "rgba(255,255,255,.78)",
            titleFont: { family: "DM Mono", size: 11 }, bodyFont: { family: "DM Mono", size: 11 },
            callbacks: {
              label: ctx => {
                const name = ctx.dataset.label;
                if (name.includes("Clients")) return ` ${name}: ${ctx.raw}`;
                return ` ${name}: ${ctx.raw.toLocaleString("en-ZA", { style:"currency", currency:"ZAR", maximumFractionDigits:0 })}`;
              }
            }
          }
        },
        scales: {
          x:  { ticks: { color: "rgba(255,255,255,.42)", font: { family: "DM Mono", size: 10 }, maxRotation: 0, maxTicksLimit: 8 }, grid: { color: "rgba(255,255,255,.04)" } },
          y:  { ticks: { color: "rgba(255,255,255,.42)", font: { family: "DM Mono", size: 10 }, callback: v => "R" + Number(v).toLocaleString("en-ZA") }, grid: { color: "rgba(255,255,255,.04)" } },
          y2: { position: "right", ticks: { color: "rgba(255,255,255,.30)", font: { family: "DM Mono", size: 10 } }, grid: { drawOnChartArea: false } }
        }
      };
      if (!chart) { chart = new Chart(ctx, { type: "line", data, options: opts }); }
      else { chart.data = data; chart.update("active"); }
    }

    function renderMetrics(m) {
      const find = name => { const row = m.data.find(r => (r["Metric"] || "").toLowerCase() === name.toLowerCase()); return row ? row["Value"] : ""; };
      ["kpiRevenue","kpiClients","kpiPipeline"].forEach(id => el(id).classList.remove("skeleton"));
      animateCount(el("kpiRevenue"),  find("Revenue"),        true);
      animateCount(el("kpiClients"),  find("Active Clients"), false);
      animateCount(el("kpiPipeline"), find("Pipeline Value"), true);
    }

    function renderSignal(s) {
      const labels   = s.data.map(r => safe(r["Date"])).filter(Boolean);
      const revenue  = s.data.map(r => toNum(r["Revenue (ZAR)"]) || 0);
      const pipeline = s.data.map(r => toNum(r["Pipeline (ZAR)"]) || 0);
      const clients  = s.data.map(r => toNum(r["Clients"]) || 0);
      buildChart(labels, revenue, pipeline, clients);
      el("signalMeta").textContent = labels.length ? labels[0] + " → " + labels[labels.length-1] : "—";
    }

    function stageClass(s) {
      const v = (s || "").toLowerCase();
      if (v.includes("won") || v.includes("closed"))   return "won";
      if (v.includes("lost"))                           return "lost";
      if (v.includes("hot") || v.includes("proposal")) return "hot";
      return "";
    }

    function renderPipeline(p) {
      const body = el("pipelineBody");
      body.innerHTML = "";
      if (!p.data.length) { body.innerHTML = `<tr><td colspan="6"><div class="empty">No deals yet.</div></td></tr>`; el("pipelineMeta").textContent = "—"; return; }
      p.data.forEach(r => {
        const tr = document.createElement("tr");
        const deal = toNum(r["Deal Value"]), prob = toNum(r["Probability"]), weighted = toNum(r["Weighted Value"]), stage = safe(r["Stage"]);
        tr.innerHTML = `
          <td>${safe(r["Client"]) || "—"}</td>
          <td class="td-right td-mono">${fmtZAR(deal)}</td>
          <td><span class="stage ${stageClass(stage)}">${stage || "—"}</span></td>
          <td class="td-right td-mono td-muted">${isFinite(prob) ? (prob * (prob <= 1 ? 100 : 1)).toFixed(0) + "%" : "—"}</td>
          <td class="td-right td-accent">${fmtZAR(weighted)}</td>
          <td class="td-mono td-muted">${safe(r["Expected Close"]) || "—"}</td>
        `;
        body.appendChild(tr);
      });
      el("pipelineMeta").textContent = p.data.length + " deal" + (p.data.length !== 1 ? "s" : "");
    }

    function renderActivity(a) {
      const body = el("activityBody");
      body.innerHTML = "";
      if (!a.data.length) { body.innerHTML = `<tr><td colspan="5"><div class="empty">No activity yet.</div></td></tr>`; el("activityMeta").textContent = "—"; return; }
      a.data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="td-mono td-muted">${safe(r["Date"]) || "—"}</td>
          <td>${safe(r["Client"]) || "—"}</td>
          <td>${safe(r["Event"]) || "—"}</td>
          <td class="td-muted">${safe(r["Type"]) || "—"}</td>
          <td class="td-muted">${safe(r["Owner"]) || "—"}</td>
        `;
        body.appendChild(tr);
      });
      el("activityMeta").textContent = a.data.length + " log" + (a.data.length !== 1 ? "s" : "");
    }

    async function refresh() {
      try {
        const [metrics, signal, pipeline, activity] = await Promise.all([
          fetchCSV(CSV.metrics), fetchCSV(CSV.signal), fetchCSV(CSV.pipeline), fetchCSV(CSV.activity)
        ]);
        renderMetrics(metrics); renderSignal(signal); renderPipeline(pipeline); renderActivity(activity);
        fails = 0; lastOk = Date.now();
        setStatus("connected");
        el("lastSync").textContent = new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
      } catch (err) {
        fails++;
        const age = lastOk ? (Date.now() - lastOk) / 1000 : Infinity;
        setStatus(fails >= MAX_FAILS && age > REFRESH_MS / 1000 * 2 ? "error" : "degraded", "retrying");
      }
      if (lastOk) {
        const ageS = Math.floor((Date.now() - lastOk) / 1000);
        el("footerStatus").textContent = "Live control panel · last sync " + ageS + "s ago";
      }
    }

    setStatus("degraded", "booting");
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
